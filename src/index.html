<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grafito</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=WDXL+Lubrifont+TC&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <style>
      body {
        font-family: "WDXL Lubrifont TC", sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh; /* Ensure body takes at least full viewport height */
      }
      main {
        flex-grow: 1; /* Allow main content to grow and push footer down */
      }
      #filters-sidebar.collapsed {
        width: 0px !important; /* Override inline style */
        padding-left: 0px !important;
        padding-right: 0px !important;
        border-right: none !important;
        overflow: hidden;
        transition: width 0.3s ease, padding 0.3s ease;
      }
      #loading-spinner {
        /* Default state: hidden */
        display: none;
      }
      #loading-spinner.htmx-request {
        /* Overlay styles */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex; /* Use flex to center content */
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
        z-index: 1000; /* High z-index to be on top */
        color: white; /* Make text white for contrast */
      }
    </style>
  </head>
  <body
    hx-get="services"
    hx-target="#unit-suggestions"
    hx-trigger="load"
    hx-swap="innerHTML"
  >
    <header class="container-fluid" style="padding: 20px">
      <hgroup
        style="
          display: flex;
          justify-content: space-between;
          align-items: baseline;
        "
      >
        <h1
          style="font-size: 2em; font-family: 'WDXL Lubrifont TC', sans-serif"
        >
          Grafito
        </h1>
        <span style="font-size: 1em">A simple log viewer</span>
      </hgroup>
    </header>
    <hr class="container-fluid" />
    <!-- Added horizontal line -->
    <div
      class="container-fluid"
      style="display: flex; gap: var(--spacing, 1rem); padding: 20px"
    >
      <button
        id="toggle-sidebar-btn"
        class="secondary outline"
        aria-expanded="true"
        aria-controls="filters-sidebar"
        title="Hide Filters Sidebar"
        style="
          height: 2.5rem;
          width: 2.5rem;
          flex-shrink: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0;
          align-self: flex-start;
          position: sticky;
          top: var(--spacing, 1rem);
          z-index: 10;
        "
      >
        «
      </button>
      <aside
        id="filters-sidebar"
        style="
          width: 300px;
          flex-shrink: 0;
          border-right: 1px solid var(--muted-border-color, #ccc);
          padding-right: var(--spacing, 1rem);
          padding-left: var(--spacing, 1rem);
          position: sticky;
          top: var(--spacing, 1rem);
          align-self: flex-start;
          max-height: calc(100vh - 2 * var(--spacing, 1rem));
          overflow-y: auto;
          z-index: 5;
        "
      >
        <!-- Removed button from here -->
        <!-- Search Box Moved Here -->
        <div style="width: 100%; margin-bottom: var(--form-element-spacing-vertical);">
          <input
            type="search"
            id="search-box"
            placeholder="Search logs..."
            title="Enter text to search in log messages (uses journalctl -g)"
            hx-get="logs"
            hx-trigger="keyup changed delay:500ms"
            hx-target="#results"
            name="q"
            hx-indicator="#loading-spinner"
            hx-include="#unit-filter, #tag-filter, #priority-filter, #time-range-filter, #live-view"
            style="width: 100%; height: 2.5rem"
          />
        </div>

        <!-- Unit and Tag Filters -->
        <div
          style="
            display: flex;
            align-items: center;
            gap: var(--spacing, 1rem); /* Add space between items */
            margin-bottom: var(
              --form-element-spacing-vertical
            ); /* Space between filter rows */
            flex-direction: column; /* Stack filters vertically in sidebar */
          "
        >
          <div style="width: 100%">
            <input
              type="text"
              id="unit-filter"
              name="unit"
              list="unit-suggestions"
              placeholder="Unit (e.g., docker)"
              title="Filter logs by systemd unit (e.g., nginx)"
              hx-get="logs"
              hx-trigger="keyup changed delay:500ms"
              hx-target="#results"
              hx-indicator="#loading-spinner"
              hx-include="#search-box, #tag-filter, #priority-filter, #time-range-filter, #live-view"
              style="width: 100%"
            />
          </div>
          <div style="width: 100%">
            <input
              type="text"
              id="tag-filter"
              name="tag"
              placeholder="Syslog Tag (e.g., myapp)"
              title="Filter logs by syslog identifier (tag)"
              hx-get="logs"
              hx-trigger="keyup changed delay:500ms"
              hx-target="#results"
              hx-indicator="#loading-spinner"
              hx-include="#search-box, #unit-filter, #priority-filter, #time-range-filter, #live-view"
              style="width: 100%"
            />
          </div>
        </div>

        <!-- Row 3: Time and Priority Filters -->
        <div
          style="
            display: flex;
            align-items: center; /* Vertically align items */
            gap: var(--spacing, 1rem); /* Add space between items */
            flex-direction: column; /* Stack filters vertically in sidebar */
            margin-bottom: var(--form-element-spacing-vertical);
          "
        >
          <div style="width: 100%">
            <select
              id="time-range-filter"
              name="since"
              hx-get="logs"
              title="Filter logs by time range"
              hx-trigger="change"
              hx-target="#results"
              hx-indicator="#loading-spinner"
              hx-include="#search-box, #unit-filter, #priority-filter, #tag-filter, #live-view"
              style="width: 100%"
            >
              <option value="">Any time</option>
              <!-- Default/no filter -->
              <option value="-15m">Last 15 minutes</option>
              <option value="-1h">Last 1 hour</option>
              <option value="-1d">Last 24 hours</option>
              <option value="-7d">Last week</option>
              <option value="-1M">Last month</option>
              <option value="-3M">Last 3 months</option>
              <option value="-1y">Last year</option>
              <!-- You could add more specific date/time inputs here if needed -->
            </select>
          </div>
          <div style="width: 100%">
            <select
              id="priority-filter"
              name="priority"
              hx-get="logs"
              title="Filter logs by priority level"
              hx-trigger="change"
              hx-target="#results"
              hx-indicator="#loading-spinner"
              hx-include="#search-box, #unit-filter, #tag-filter, #time-range-filter, #live-view"
              style="width: 100%"
            >
              <option value="0">Emergency</option>
              <option value="1">Alert</option>
              <option value="2">Critical</option>
              <option value="3">Error</option>
              <option value="4">Warning</option>
              <option value="5" selected>Notice</option>
              <option value="6">Informational</option>
              <option value="7">Debug</option>
            </select>
          </div>
        </div>
        <div
          style="
            border-top: 1px solid var(--muted-border-color, #ccc);
            padding-top: var(--spacing, 1rem);
          "
        >
          <!-- Help button for command -->
          <div
            style="
              display: flex;
              align-items: center;
              gap: var(--spacing, 0.5rem);
            "
          >
            <button
              id="show-command-button"
              class="secondary"
              aria-label="Show equivalent command"
              title="Show equivalent journalctl command"
              hx-get="command"
              hx-include="#search-box, #unit-filter, #priority-filter, #tag-filter, #time-range-filter, #live-view"
              hx-trigger="click"
              hx-swap="none"
              hx-on:htmx:after-request="if(event.detail.successful) alert('These filters are the equivalent of: ' + event.detail.xhr.responseText); else alert('Error fetching command: ' + event.detail.xhr.statusText + '\\nCheck console for more details.');"
              style="
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 50%;
                padding: 0;
                display: inline-flex;
                align-items: center;
                justify-content: center;
              "
            >
              ❔
            </button>
            <button
              id="copy-link-button"
              class="secondary"
              aria-label="Copy shareable link"
              title="Copy link with current filters"
              onclick="copyShareableLink()"
              style="
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 50%;
                padding: 0;
                display: inline-flex;
                align-items: center;
                justify-content: center;
              "
            >
              🔗
            </button>
            <div style="margin-left: auto; display: flex; align-items: center">
              <label
                for="live-view"
                role="switch"
                style="display: flex; align-items: center"
                title="Toggle live log updates every 10 seconds"
              >
                <input
                  type="checkbox"
                  id="live-view"
                  name="live-view"
                  role="switch"
                  hx-get="logs"
                  hx-target="#results"
                  hx-indicator="#loading-spinner"
                  hx-include="#search-box, #unit-filter, #priority-filter, #tag-filter, #time-range-filter"
                />
                Live
              </label>
            </div>
          </div>
        </div>
        <datalist id="unit-suggestions"></datalist>
      </aside>
      <main style="flex-grow: 1; min-width: 0; overflow-x: hidden">
        <!-- Spinner Element -->
        <div id="loading-spinner" class="htmx-indicator">
          <div
            style="
              padding: 20px;
              background-color: rgba(0, 0, 0, 0.3);
              border-radius: var(--border-radius);
            "
          >
            Loading...
            <span
              aria-busy="true"
              style="--primary: white; --primary-inverse: #333"
            ></span>
          </div>
        </div>

        <!-- Hidden poller for live view updates (no spinner) -->
        <div
          id="live-view-poller"
          style="display: none"
          hx-get="logs"
          hx-trigger="every 10s[document.getElementById('live-view').checked]"
          hx-target="#results"
          hx-include="#search-box, #unit-filter, #priority-filter, #tag-filter, #time-range-filter, #live-view"
        ></div>

        <div
          id="results"
          hx-get="logs"
          hx-trigger="initial-load-event from:body"
          hx-indicator="#loading-spinner"
          hx-include="#search-box, #unit-filter, #priority-filter, #tag-filter, #time-range-filter, #live-view"
          style="
            white-space: pre-wrap;
            font-family: monospace;
            overflow-x: auto;
          "
          hx-target="this"
        >
          <!-- Results will be displayed here -->
        </div>
      </main>
    </div>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <footer
      class="container-fluid"
      style="
        text-align: center;
        padding-top: 20px;
        padding-bottom: 20px;
        margin-top: 20px;
        border-top: 1px solid var(--muted-border-color);
      "
    >
      <small>
        <a href="https://links.ralsina.me" style="text-decoration: none"
          >© 2025 Roberto Alsina</a
        >
        |
        <a href="https://grafito.ralsina.me" style="text-decoration: none"
          >🏚 grafito.ralsina.me</a
        >
        |
        <a
          href="https://github.com/ralsina/grafito"
          style="text-decoration: none"
        >
          ⌨ ralsina/grafito
        </a>
      </small>
    </footer>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);

        const searchBox = document.getElementById("search-box");
        if (params.has("q") && searchBox) {
          searchBox.value = params.get("q");
        }

        const unitFilter = document.getElementById("unit-filter");
        if (params.has("unit") && unitFilter) {
          unitFilter.value = params.get("unit");
        }

        const tagFilter = document.getElementById("tag-filter");
        if (params.has("tag") && tagFilter) {
          tagFilter.value = params.get("tag");
        }

        const timeRangeFilter = document.getElementById("time-range-filter");
        if (params.has("since") && timeRangeFilter) {
          // Ensure the value exists as an option before setting it
          if (
            Array.from(timeRangeFilter.options).some(
              (opt) => opt.value === params.get("since")
            )
          ) {
            timeRangeFilter.value = params.get("since");
          }
        }

        const liveViewCheckbox = document.getElementById("live-view");
        if (params.has("live-view") && liveViewCheckbox) {
          liveViewCheckbox.checked = params.get("live-view") === "on";
        }
        const priorityFilter = document.getElementById("priority-filter");
        if (params.has("priority") && priorityFilter) {
          if (
            Array.from(priorityFilter.options).some(
              (opt) => opt.value === params.get("priority")
            )
          ) {
            priorityFilter.value = params.get("priority");
          }
        }

        // Sidebar Toggle Functionality
        const toggleButton = document.getElementById("toggle-sidebar-btn");
        const sidebar = document.getElementById("filters-sidebar");

        function setSidebarState(isCollapsed) {
          if (sidebar && toggleButton) {
            if (isCollapsed) {
              sidebar.classList.add("collapsed");
              toggleButton.textContent = "»";
              toggleButton.setAttribute("aria-expanded", "false");
              toggleButton.setAttribute("title", "Show Filters Sidebar");
            } else {
              sidebar.classList.remove("collapsed");
              toggleButton.textContent = "«";
              toggleButton.setAttribute("aria-expanded", "true");
              toggleButton.setAttribute("title", "Hide Filters Sidebar");
            }
          }
        }

        if (toggleButton && sidebar) {
          toggleButton.addEventListener("click", () => {
            const isCollapsed = sidebar.classList.contains("collapsed");
            setSidebarState(!isCollapsed); // Toggle the state
            localStorage.setItem("sidebarCollapsed", !isCollapsed);
          });

          // Apply initial state from localStorage
          const savedState = localStorage.getItem("sidebarCollapsed");
          if (savedState !== null) {
            setSidebarState(savedState === "true");
          } else {
            setSidebarState(false); // Default to expanded if no saved state
          }

          // Trigger the initial load for #results after filters are set from URL
          htmx.trigger(document.body, "initial-load-event", {});
        }
      });

      function copyShareableLink() {
        const params = new URLSearchParams();

        const searchBox = document.getElementById("search-box");
        if (searchBox && searchBox.value) {
          params.set("q", searchBox.value);
        }

        const unitFilter = document.getElementById("unit-filter");
        if (unitFilter && unitFilter.value) {
          params.set("unit", unitFilter.value);
        }

        const tagFilter = document.getElementById("tag-filter");
        if (tagFilter && tagFilter.value) {
          params.set("tag", tagFilter.value);
        }

        const timeRangeFilter = document.getElementById("time-range-filter");
        if (timeRangeFilter && timeRangeFilter.value) {
          params.set("since", timeRangeFilter.value);
        }

        const liveViewCheckbox = document.getElementById("live-view");
        if (liveViewCheckbox && liveViewCheckbox.checked) {
          params.set("live-view", "on");
        }

        const priorityFilter = document.getElementById("priority-filter");
        if (priorityFilter && priorityFilter.value) {
          params.set("priority", priorityFilter.value);
        }

        const shareUrl =
          window.location.origin +
          window.location.pathname +
          "?" +
          params.toString();
        navigator.clipboard
          .writeText(shareUrl)
          .then(() => alert("Link copied to clipboard!"))
          .catch((err) => alert("Failed to copy link: " + err));
      }
    </script>
  </body>
</html>
