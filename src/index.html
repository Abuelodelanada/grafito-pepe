<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=WDXL+Lubrifont+TC&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="style.css" />
    <title>Grafito Log Viewer</title>
    <script
      src="https://unpkg.com/htmx.org@1.9.10"
      integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
      crossorigin="anonymous"
    ></script>
  </head>
  <body
    hx-get="services"
    hx-target="#unit-suggestions"
    hx-trigger="load"
    hx-swap="innerHTML"
  >
    <div id="page-content-layout" class="container-fluid">
      <button
        id="toggle-sidebar-btn"
        class="secondary outline"
        aria-expanded="true"
        aria-controls="filters-sidebar"
        title="Hide Filters Sidebar"
      >
        ‚û°Ô∏è
      </button>
      <aside id="filters-sidebar">
        <hgroup class="sidebar-header-info">
          <h1>
            <a href="https://grafito.ralsina.me" class="grafito-title-link"
              >Grafito</a
            >
          </h1>
          <span>A simple log viewer</span>
        </hgroup>
        <hr />
        <div>
          <input
            type="search"
            id="search-box"
            placeholder="Search logs..."
            title="Enter text to search in log messages (uses journalctl -g)"
            hx-get="logs"
            hx-trigger="keyup changed delay:500ms"
            hx-target="#results"
            name="q"
            class="log-filter"
            hx-indicator="#loading-spinner"
            hx-include=".log-filter"
          />
        </div>

        <!-- Unit and Tag Filters -->
        <div class="filter-group">
          <div>
            <input
              type="text"
              id="unit-filter"
              name="unit"
              list="unit-suggestions"
              placeholder="Unit (e.g., docker)"
              title="Filter logs by systemd unit (e.g., nginx)"
              hx-get="logs"
              hx-trigger="keyup changed delay:500ms"
              hx-target="#results"
              class="log-filter"
              hx-indicator="#loading-spinner"
              hx-include=".log-filter"
            />
          </div>
          <div>
            <input
              type="text"
              id="tag-filter"
              name="tag"
              placeholder="Syslog Tag (e.g., myapp)"
              title="Filter logs by syslog identifier (tag)"
              hx-get="logs"
              hx-trigger="keyup changed delay:500ms"
              hx-target="#results"
              class="log-filter"
              hx-indicator="#loading-spinner"
              hx-include=".log-filter"
            />
          </div>
        </div>

        <!-- Row 3: Time and Priority Filters -->
        <div class="filter-group">
          <div>
            <select
              id="time-range-filter"
              name="since"
              hx-get="logs"
              title="Filter logs by time range"
              hx-trigger="change"
              hx-target="#results"
              class="log-filter"
              hx-indicator="#loading-spinner"
              hx-include=".log-filter"
            >
              <option value="">Any time</option>
              <!-- Default/no filter -->
              <option value="-15m">Last 15 minutes</option>
              <option value="-1h">Last 1 hour</option>
              <option value="-1d">Last 24 hours</option>
              <option value="-7d">Last week</option>
              <option value="-1M">Last month</option>
              <option value="-3M">Last 3 months</option>
              <option value="-1y">Last year</option>
              <!-- You could add more specific date/time inputs here if needed -->
            </select>
          </div>
          <div>
            <select
              id="priority-filter"
              name="priority"
              hx-get="logs"
              title="Filter logs by priority level"
              hx-trigger="change"
              hx-target="#results"
              class="log-filter"
              hx-indicator="#loading-spinner"
              hx-include=".log-filter"
            >
              <option value="0">Emergency</option>
              <option value="1">Alert</option>
              <option value="2">Critical</option>
              <option value="3">Error</option>
              <option value="4">Warning</option>
              <option value="5" selected>Notice</option>
              <option value="6">Informational</option>
              <option value="7">Debug</option>
            </select>
          </div>
        </div>
        <div class="sidebar-actions-area">
          <!-- Help button for command -->
          <div class="sidebar-buttons-row">
            <button
              id="show-command-button"
              class="secondary"
              aria-label="Show equivalent command"
              title="Show equivalent journalctl command"
              hx-get="command"
              hx-include=".log-filter"
              hx-trigger="click"
              hx-swap="none"
              hx-on:htmx:after-request="if(event.detail.successful) alert('These filters are the equivalent of: ' + event.detail.xhr.responseText); else alert('Error fetching command: ' + event.detail.xhr.statusText + '\\nCheck console for more details.');"
            >
              ‚ùî
            </button>
            <button
              id="copy-link-button"
              class="secondary"
              aria-label="Copy shareable link"
              title="Copy link with current filters"
              onclick="copyShareableLink()"
            >
              üîó
            </button>
            <div class="live-view-controls">
              <label
                for="live-view"
                role="switch"
                title="Toggle live log updates every 10 seconds"
              >
                <input
                  type="checkbox"
                  id="live-view"
                  name="live-view"
                  role="switch"
                  class="log-filter"
                  hx-get="logs"
                  hx-target="#results"
                  hx-indicator="#loading-spinner"
                />
                Live
              </label>
            </div>
          </div>
        </div>
        <datalist id="unit-suggestions"></datalist>
        <footer class="container-fluid">
          <a href="https://links.ralsina.me">¬©Ô∏è 2025 Roberto Alsina</a> //
          <a href="https://grafito.ralsina.me">üè†</a> //
          <a href="https://github.com/ralsina/grafito">üñ•Ô∏è</a>
        </footer>
      </aside>
      <main>
        <!-- Spinner Element -->
        <div id="loading-spinner" class="htmx-indicator">
          <div>
            Loading...
            <span aria-busy="true"></span>
          </div>
        </div>

        <!-- Hidden poller for live view updates (no spinner) -->
        <div
          id="live-view-poller"
          hx-get="logs"
          hx-trigger="every 10s[document.getElementById('live-view').checked]"
          hx-target="#results"
          hx-include=".log-filter"
        ></div>

        <div
          id="results"
          hx-get="logs"
          hx-trigger="initial-load-event from:body"
          hx-indicator="#loading-spinner"
          hx-include=".log-filter"
          hx-target="this"
        >
          <!-- Results will be displayed here -->
        </div>
      </main>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);

        const filterConfigs = [
          { id: "search-box", param: "q", type: "value" },
          { id: "unit-filter", param: "unit", type: "value" },
          { id: "tag-filter", param: "tag", type: "value" },
          { id: "time-range-filter", param: "since", type: "select" },
          { id: "priority-filter", param: "priority", type: "select" },
          {
            id: "live-view",
            param: "live-view",
            type: "checkbox",
            trueValue: "on",
          },
        ];

        filterConfigs.forEach((config) => {
          const element = document.getElementById(config.id);
          if (params.has(config.param) && element) {
            const paramValue = params.get(config.param);
            if (config.type === "value") {
              element.value = paramValue;
            } else if (config.type === "select") {
              if (
                Array.from(element.options).some(
                  (opt) => opt.value === paramValue
                )
              ) {
                element.value = paramValue;
              }
            } else if (config.type === "checkbox") {
              element.checked = paramValue === config.trueValue;
            }
          }
        });

        // Sidebar Toggle Functionality
        const toggleButton = document.getElementById("toggle-sidebar-btn");
        const sidebar = document.getElementById("filters-sidebar");
        const mainContent = document.querySelector("main"); // Assuming main content area

        function setSidebarState(isCollapsed) {
          if (sidebar && toggleButton) {
            if (isCollapsed) {
              sidebar.classList.add("collapsed");
              toggleButton.innerHTML = "&#10145;&#65039;"; // Right arrow emoji ‚û°Ô∏è
              toggleButton.setAttribute("aria-expanded", "false");
              toggleButton.setAttribute("title", "Show Filters Sidebar");
              if (mainContent) mainContent.style.marginLeft = "0";
            } else {
              sidebar.classList.remove("collapsed");
              toggleButton.innerHTML = "&#11013;&#65039;"; // Left arrow emoji ‚¨ÖÔ∏è
              toggleButton.setAttribute("aria-expanded", "true");
              toggleButton.setAttribute("title", "Hide Filters Sidebar");
              if (mainContent) mainContent.style.marginLeft = ""; // Reset margin or set to sidebar width
            }
          }
        }

        if (toggleButton && sidebar) {
          toggleButton.addEventListener("click", () => {
            const isCollapsed = sidebar.classList.contains("collapsed");
            setSidebarState(!isCollapsed);
            localStorage.setItem("sidebarCollapsed", !isCollapsed);
          });

          // Apply initial state from localStorage
          const savedState = localStorage.getItem("sidebarCollapsed");
          if (savedState !== null) {
            setSidebarState(savedState === "true");
          } else {
            setSidebarState(false); // Default to expanded if no saved state
          }

          // Trigger the initial load for #results after filters are set from URL
          htmx.trigger(document.body, "initial-load-event", {});
        }

        // Disable copy link button if not in a secure context
        const copyLinkButton = document.getElementById("copy-link-button");
        if (copyLinkButton && !window.isSecureContext) {
          copyLinkButton.disabled = true;
          copyLinkButton.title =
            "Cannot copy link: Page is not loaded in a secure context (HTTPS).";
        }
      });

      function copyShareableLink() {
        const params = new URLSearchParams();
        const filterConfigs = [
          // Re-use or define a similar config array
          { id: "search-box", param: "q", type: "value" },
          { id: "unit-filter", param: "unit", type: "value" },
          { id: "tag-filter", param: "tag", type: "value" },
          { id: "time-range-filter", param: "since", type: "value" }, // Selects also have .value
          { id: "priority-filter", param: "priority", type: "value" }, // Selects also have .value
          {
            id: "live-view",
            param: "live-view",
            type: "checkbox",
            trueValue: "on",
          },
        ];

        filterConfigs.forEach((config) => {
          const element = document.getElementById(config.id);
          if (element) {
            if (config.type === "checkbox") {
              if (element.checked) {
                params.set(config.param, config.trueValue);
              }
            } else if (element.value) {
              // For text inputs and selects with a value
              params.set(config.param, element.value);
            }
          }
        });

        const shareUrl =
          window.location.origin +
          window.location.pathname +
          "?" +
          params.toString();
        navigator.clipboard
          .writeText(shareUrl)
          .then(() => alert("Link copied to clipboard!"))
          .catch((err) => alert("Failed to copy link: " + err));
      }
    </script>
  </body>
</html>
